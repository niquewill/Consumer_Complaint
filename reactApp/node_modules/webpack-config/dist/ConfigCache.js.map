{"version":3,"sources":["../src/ConfigCache.js"],"names":["PERSISTENT_KEY","ENVIRONMENT","VALUE_RESOLVERS","ConfigCache","environment","valueResolvers","set","from","key","value","persistent","has","require","cache","resolve","x","get","getOrDefault"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AAGA;;;;AACA;;;;;;AAEA;;;;AAIA,IAAMA,iBAAiB,sBAAvB;;AAEA;;;;AAIA,IAAMC,cAAc,uBAApB;;AAEA;;;;AAIA,IAAMC,kBAAkB,uBAAxB;;AAEA;;;;;;IAKMC,W;;;AACF;;;;;AAKA,yBAAYC,WAAZ,EAA6D;AAAA,YAApCC,cAAoC;AAAA;;AAAA;;AAGzDJ,oBAAYK,GAAZ,QAAsBF,WAAtB;AACAF,wBAAgBI,GAAhB,QAA0B,6BAAmBC,IAAnB,CAAwBF,cAAxB,CAA1B;AAJyD;AAK5D;;AAED;;;;;;;;;;AAsCA;;;4BAGIG,G,EAAK;AACL,gBAAIC,cAAJ;;AAEA,gBAAI,KAAKC,UAAT,EAAqB;AACjB,oBAAI,CAAC,KAAKC,GAAL,CAASH,GAAT,CAAL,EAAoB;AAChBC,4BAAQG,QAAQJ,GAAR,CAAR;;AAEA,yBAAKF,GAAL,CAASE,GAAT,EAAcC,KAAd;AACH,iBAJD,MAIO;AACHA,gKAAkBD,GAAlB;AACH;AACJ,aARD,MAQO;AACH,uBAAOI,QAAQC,KAAR,CAAcL,GAAd,CAAP;;AAEAC,wBAAQG,QAAQJ,GAAR,CAAR;AACH;;AAED,mBAAO,KAAKH,cAAL,CAAoBS,OAApB,CAA4BL,KAA5B,EAAmC;AAAA,uBAAK,CAAC,yBAAYM,CAAZ,CAAN;AAAA,aAAnC,CAAP;AACH;;;4BAvDiB;AACd,mBAAOd,YAAYe,GAAZ,CAAgB,IAAhB,CAAP;AACH;;AAED;;;;;;4BAGiB;AACb,mBAAO,KAAKZ,WAAL,CAAiBa,YAAjB,CAA8BjB,cAA9B,EAA8C,IAA9C,MAAwD,IAA/D;AACH;;AAED;;;;;;;;;;;;0BAWeS,K,EAAO;AAClB,iBAAKL,WAAL,CAAiBE,GAAjB,CAAqBN,cAArB,EAAqCS,KAArC;AACH;;AAED;;;;;;;4BAIqB;AACjB,mBAAOP,gBAAgBc,GAAhB,CAAoB,IAApB,CAAP;AACH;;;;;kBA0BUb,W","file":"ConfigCache.js","sourcesContent":["import {\n    isUndefined,\n} from 'lodash';\nimport ConfigStrategyList from './ConfigStrategyList';\nimport DEFAULT_RESOLVERS from './ConfigCacheResolvers';\n\n/**\n * @private\n * @type {String}\n */\nconst PERSISTENT_KEY = 'WEBPACK_CONFIG_CACHE';\n\n/**\n * @private\n * @type {WeakMap}\n */\nconst ENVIRONMENT = new WeakMap();\n\n/**\n * @private\n * @type {WeakMap}\n */\nconst VALUE_RESOLVERS = new WeakMap();\n\n/**\n * Please set `WEBPACK_CONFIG_CACHE` environment variable to `false` to make it non persistent or just use {@link ConfigCache#persistent}\n * @class\n * @extends {Map}\n */\nclass ConfigCache extends Map {\n    /**\n     * @constructor\n     * @param {ConfigEnvironment} environment\n     * @param {Function[]} [valueResolvers]\n     */\n    constructor(environment, valueResolvers = DEFAULT_RESOLVERS) {\n        super();\n\n        ENVIRONMENT.set(this, environment);\n        VALUE_RESOLVERS.set(this, ConfigStrategyList.from(valueResolvers));\n    }\n\n    /**\n     * @readonly\n     * @type {ConfigEnvironment}\n     */\n    get environment() {\n        return ENVIRONMENT.get(this);\n    }\n\n    /**\n     * @type {Boolean}\n     */\n    get persistent() {\n        return this.environment.getOrDefault(PERSISTENT_KEY, true) === true;\n    }\n\n    /**\n     * @example\n     * import {\n     *   cache\n     * } from 'webpack-config';\n     *\n     * cache.persistent = false;\n     * @example\n     * WEBPACK_CONFIG_CACHE=false ...\n     * @param {Boolean} value\n     */\n    set persistent(value) {\n        this.environment.set(PERSISTENT_KEY, value);\n    }\n\n    /**\n     * @readonly\n     * @type {ConfigStrategyList}\n     */\n    get valueResolvers() {\n        return VALUE_RESOLVERS.get(this);\n    }\n\n    /**\n     * @override\n     */\n    get(key) {\n        let value;\n\n        if (this.persistent) {\n            if (!this.has(key)) {\n                value = require(key);\n\n                this.set(key, value);\n            } else {\n                value = super.get(key);\n            }\n        } else {\n            delete require.cache[key];\n\n            value = require(key);\n        }\n\n        return this.valueResolvers.resolve(value, x => !isUndefined(x));\n    }\n}\n\nexport default ConfigCache;\n"]}