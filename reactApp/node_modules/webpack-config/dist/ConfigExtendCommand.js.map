{"version":3,"sources":["../src/ConfigExtendCommand.js"],"names":["LOADER","FACTORY","ConfigExtendCommand","optionsResolver","loader","factory","set","config","options","normalizedOptions","normalizeOptions","forEach","resolve","value","filename","transforms","pendingConfig","loadConfig","dependencyTree","children","push","prevConfig","clone","currConfig","transform","call","createConfig","merge","toObject","get","Array","isArray"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AAIA;;;;AACA;;;;AACA;;;;AACA;;;;;;AAEA;;;;AAIA;;;;AAIA;;;;AAIA,IAAMA,SAAS,uBAAf;;AAEA;;;;AAIA,IAAMC,UAAU,uBAAhB;;AAEA;;;;;IAIMC,mB;;;AACF;;;;;;AAMA,iCAAYC,eAAZ,EAA6BC,MAA7B,EAAqCC,OAArC,EAA8C;AAAA;;AAAA,oKACpCF,eADoC;;AAG1CH,eAAOM,GAAP,QAAiBF,MAAjB;AACAH,gBAAQK,GAAR,QAAkBD,OAAlB;AAJ0C;AAK7C;;AAED;;;;;;;;;;AAgBA;;;gCAGQE,M,EAAQC,O,EAAS;AAAA;;AACrB,gBAAMC,oBAAoBP,oBAAoBQ,gBAApB,CAAqCF,OAArC,CAA1B;;AAEAC,8BAAkBE,OAAlB,CAA0B,iBAAS;AAAA,4CACE,OAAKR,eAAL,CAAqBS,OAArB,CAA6BL,MAA7B,EAAqCM,KAArC,CADF;AAAA,oBACvBC,QADuB,yBACvBA,QADuB;AAAA,oBACbC,UADa,yBACbA,UADa;;AAE/B,oBAAMC,gBAAgB,OAAKZ,MAAL,CAAYa,UAAZ,CAAuBH,QAAvB,CAAtB;;AAEA,oBAAIE,yCAAJ,EAAqC;AAAA;AACjCT,+BAAOW,cAAP,CAAsBC,QAAtB,CAA+BC,IAA/B,CAAoCJ,cAAcE,cAAlD;;AAEA,4BAAIG,aAAaL,cAAcM,KAAd,EAAjB;;AAEAP,mCAAWJ,OAAX,CAAmB,qBAAa;AAC5B,gCAAMY,aAAaC,UAAUC,IAAV,CAAelB,MAAf,EAAuBc,UAAvB,CAAnB;;AAEA,gCAAI,CAAC,sBAASE,UAAT,CAAL,EAA2B;AACvBF,6CAAa,EAAb;AACH,6BAFD,MAEO;AACHA,6CAAaE,UAAb;AACH;;AAED,gCAAI,EAAEF,sCAAF,CAAJ,EAAqC;AACjCA,6CAAa,OAAKhB,OAAL,CAAaqB,YAAb,CAA0B,EAA1B,EAA8BC,KAA9B,CAAoCN,UAApC,CAAb;AACH;AACJ,yBAZD;;AAcA,4BAAIA,sCAAJ,EAAkC;AAC9Bd,mCAAOoB,KAAP,CAAaN,WAAWO,QAAX,EAAb;AACH;AArBgC;AAsBpC;AACJ,aA3BD;AA4BH;;AAED;;;;;;;4BAhDa;AACT,mBAAO5B,OAAO6B,GAAP,CAAW,IAAX,CAAP;AACH;;AAED;;;;;;;4BAIc;AACV,mBAAO5B,QAAQ4B,GAAR,CAAY,IAAZ,CAAP;AACH;;;yCA0CuBrB,O,EAAS;AAC7B,gBAAIC,oBAAoB,EAAxB;;AAEA,gBAAI,sBAASD,OAAT,CAAJ,EAAuB;AACnBC,oCAAoB,CAAC;AACjBK,8BAAUN,OADO;AAEjBO,gCAAY;AAFK,iBAAD,CAApB;AAOH,aARD,MAQO,IAAI,sBAASP,OAAT,CAAJ,EAAuB;AAAA;AAAA;AAAA;;AAAA;AAC1B,oEAAoC,uBAAeA,OAAf,CAApC,4GAA6D;AAAA;AAAA,4BAAjDM,QAAiD;AAAA,4BAAvCU,SAAuC;;AACzD,4BAAMT,aAAae,MAAMC,OAAN,CAAcP,SAAd,IAA2BA,SAA3B,GAAuC,CAACA,SAAD,CAA1D;;AAEAf,0CAAkBW,IAAlB,CAAuB;AACnBN,8CADmB;AAEnBC,mFACOA,UADP;AAFmB,yBAAvB;AAOH;AAXyB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAY7B;;AAED,mBAAON,iBAAP;AACH;;;;;kBAGUP,mB","file":"ConfigExtendCommand.js","sourcesContent":["import {\n    isObject,\n    isString\n} from 'lodash';\nimport Config from './Config';\nimport ConfigCommand from './ConfigCommand';\nimport DEFAULT_TRANSFORM from './ConfigDefaultTransform';\nimport CLEANUP_TRANSFORM from './ConfigCleanupTransform';\n\n/**\n * @typedef {Object<String,ConfigTransform[]>} ConfigExtendOptions\n */\n\n/**\n * @typedef {String|Object<String,ConfigTransform>|ConfigExtendOptions} ConfigExtendPossibleOptions\n */\n\n/**\n * @private\n * @type {WeakMap}\n */\nconst LOADER = new WeakMap();\n\n/**\n * @private\n * @type {WeakMap}\n */\nconst FACTORY = new WeakMap();\n\n/**\n * @class\n * @extends {ConfigCommand}\n */\nclass ConfigExtendCommand extends ConfigCommand {\n    /**\n     * @constructor\n     * @param {ConfigOptionsResolver} optionsResolver\n     * @param {ConfigLoader} loader\n     * @param {ConfigFactory} factory\n     */\n    constructor(optionsResolver, loader, factory) {\n        super(optionsResolver);\n\n        LOADER.set(this, loader);\n        FACTORY.set(this, factory);\n    }\n\n    /**\n     * @readonly\n     * @type {ConfigLoader}\n     */\n    get loader() {\n        return LOADER.get(this);\n    }\n\n    /**\n     * @readonly\n     * @type {ConfigFactory}\n     */\n    get factory() {\n        return FACTORY.get(this);\n    }\n\n    /**\n     * @override\n     */\n    execute(config, options) {\n        const normalizedOptions = ConfigExtendCommand.normalizeOptions(options);\n\n        normalizedOptions.forEach(value => {\n            const { filename, transforms } = this.optionsResolver.resolve(config, value);\n            const pendingConfig = this.loader.loadConfig(filename);\n\n            if (pendingConfig instanceof Config) {\n                config.dependencyTree.children.push(pendingConfig.dependencyTree);\n\n                let prevConfig = pendingConfig.clone();\n\n                transforms.forEach(transform => {\n                    const currConfig = transform.call(config, prevConfig);\n\n                    if (!isObject(currConfig)) {\n                        prevConfig = {};\n                    } else {\n                        prevConfig = currConfig;\n                    }\n\n                    if (!(prevConfig instanceof Config)) {\n                        prevConfig = this.factory.createConfig({}).merge(prevConfig);\n                    }\n                });\n\n                if (prevConfig instanceof Config) {\n                    config.merge(prevConfig.toObject());\n                }\n            }\n        });\n    }\n\n    /**\n     * @param {ConfigExtendPossibleOptions} options\n     * @returns {ConfigExtendOptions[]}\n     */\n    static normalizeOptions(options) {\n        let normalizedOptions = [];\n\n        if (isString(options)) {\n            normalizedOptions = [{\n                filename: options,\n                transforms: [\n                    DEFAULT_TRANSFORM,\n                    CLEANUP_TRANSFORM\n                ]\n            }];\n        } else if (isObject(options)) {\n            for (const [filename, transform] of Object.entries(options)) {\n                const transforms = Array.isArray(transform) ? transform : [transform];\n\n                normalizedOptions.push({\n                    filename,\n                    transforms: [\n                        ...transforms,\n                        CLEANUP_TRANSFORM\n                    ]\n                });\n            }\n        }\n\n        return normalizedOptions;\n    }\n}\n\nexport default ConfigExtendCommand;\n"]}